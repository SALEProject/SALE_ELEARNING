M.course_dndupload={Y:null,url:M.cfg.wwwroot+'/course/dndupload.php',maxbytes:0,courseid:null,handlers:null,entercount:0,currentsection:null,uploadqueue:null,uploaddialog:false,lastselected:null,sectiontypename:'li',sectionclasses:['section','main'],pagecontentid:'page',modslistselector:'ul.section',init:function(Y,options){this.Y=Y;if(!this.browser_supported())return;this.maxbytes=options.maxbytes;this.courseid=options.courseid;this.handlers=options.handlers;this.uploadqueue=new Array();this.lastselected=new Array();var sectionselector=this.sectiontypename+'.'+this.sectionclasses.join('.'),sections=this.Y.all(sectionselector);if(sections.isEmpty())return;sections.each(function(el){this.add_preview_element(el);this.init_events(el)},this);if(options.showstatus)this.add_status_div()},add_status_div:function(){var Y=this.Y,coursecontents=Y.one('#'+this.pagecontentid),div,handlefile=(this.handlers.filehandlers.length>0),handletext=false,handlelink=false,i=0,styletop,styletopunit;if(!coursecontents)return;div=Y.Node.create('<div id="dndupload-status"></div>').setStyle('opacity','0.0');coursecontents.insert(div,0);for(i=0;i<this.handlers.types.length;i++)switch(this.handlers.types[i].identifier){case'text':case'text/html':handletext=true;break;case'url':handlelink=true;break};$msgident='dndworking';if(handlefile)$msgident+='file';if(handletext)$msgident+='text';if(handlelink)$msgident+='link';div.setContent(M.util.get_string($msgident,'moodle'));styletop=div.getStyle('top')||'0px';styletopunit=styletop.replace(/^\d+/,'');styletop=parseInt(styletop.replace(/\D*$/,''),10);var fadeanim=new Y.Anim({node:'#dndupload-status',from:{opacity:0.0,top:(styletop-30).toString()+styletopunit},to:{opacity:1.0,top:styletop.toString()+styletopunit},duration:0.5});fadeanim.once('end',function(e){this.set('reverse',1);Y.later(3e3,this,'run',null,false)});fadeanim.run()},browser_supported:function(){if(typeof FileReader=='undefined')return false;if(typeof FormData=='undefined')return false;return true},init_events:function(el){this.Y.on('dragenter',this.drag_enter,el,this);this.Y.on('dragleave',this.drag_leave,el,this);this.Y.on('dragover',this.drag_over,el,this);this.Y.on('drop',this.drop,el,this)},get_section:function(el){var sectionclasses=this.sectionclasses;return el.ancestor(function(test){var i;for(i=0;i<sectionclasses.length;i++){if(!test.hasClass(sectionclasses[i]))return false;return true}},true)},get_section_number:function(section){var sectionid=section.get('id').split('-');if(sectionid.length<2||sectionid[0]!='section')return false;return parseInt(sectionid[1])},types_includes:function(e,type){var i,types=e._event.dataTransfer.types;type=type.toLowerCase();for(i=0;i<types.length;i++){if(!types.hasOwnProperty(i))continue;if(types[i].toLowerCase()===type)return true};return false},drag_type:function(e){if(e._event.dataTransfer===null)return false;if(e._event.dataTransfer.types===null)return false;if(e._event.dataTransfer.types.length==0)return false;if(this.types_includes(e,'Files'))if(e.type!='drop'||e._event.dataTransfer.files.length!=0){if(this.handlers.filehandlers.length==0)return false;return{realtype:'Files',addmessage:M.util.get_string('addfilehere','moodle'),namemessage:null,type:'Files'}};var types=this.handlers.types;for(var i=0;i<types.length;i++){var dttypes=types[i].datatransfertypes;for(var j=0;j<dttypes.length;j++)if(this.types_includes(e,dttypes[j]))return{realtype:dttypes[j],addmessage:types[i].addmessage,namemessage:types[i].namemessage,handlermessage:types[i].handlermessage,type:types[i].identifier,handlers:types[i].handlers}};return false},check_drag:function(e){var type=this.drag_type(e);if(type){e.stopPropagation();e.preventDefault()};return type},drag_enter:function(e){if(!(type=this.check_drag(e)))return false;var section=this.get_section(e.currentTarget);if(!section)return false;if(this.currentsection&&this.currentsection!=section){this.currentsection=section;this.entercount=1}else{this.entercount++;if(this.entercount>2){this.entercount=2;return false}};this.show_preview_element(section,type);return false},drag_leave:function(e){if(!this.check_drag(e))return false;this.entercount--;if(this.entercount==1)return false;this.entercount=0;this.currentsection=null;this.hide_preview_element();return false},drag_over:function(e){this.check_drag(e);return false},drop:function(e){if(!(type=this.check_drag(e)))return false;this.hide_preview_element();var section=this.get_section(e.currentTarget),sectionnumber=this.get_section_number(section);if(type.type=='Files'){var files=e._event.dataTransfer.files;for(var i=0,f;f=files[i];i++)this.handle_file(f,section,sectionnumber)}else{var contents=e._event.dataTransfer.getData(type.realtype);if(contents)this.handle_item(type,contents,section,sectionnumber)};return false},get_mods_element:function(section){var modsel=section.one(this.modslistselector);if(!modsel){modsel=document.createElement('ul');modsel.className='section img-text';var contentel=section.get('children').pop(),brel=contentel.get('children').pop();contentel.insertBefore(modsel,brel);modsel=this.Y.one(modsel)};return modsel},add_resource_element:function(name,section,module){var modsel=this.get_mods_element(section),resel={parent:modsel,li:document.createElement('li'),div:document.createElement('div'),indentdiv:document.createElement('div'),a:document.createElement('a'),icon:document.createElement('img'),namespan:document.createElement('span'),groupingspan:document.createElement('span'),progressouter:document.createElement('span'),progress:document.createElement('span')};resel.li.className='activity '+module+' modtype_'+module;resel.indentdiv.className='mod-indent';resel.li.appendChild(resel.indentdiv);resel.div.className='activityinstance';resel.indentdiv.appendChild(resel.div);resel.a.href='#';resel.div.appendChild(resel.a);resel.icon.src=M.util.image_url('i/ajaxloader');resel.icon.className='activityicon iconlarge';resel.a.appendChild(resel.icon);resel.namespan.className='instancename';resel.namespan.innerHTML=name;resel.a.appendChild(resel.namespan);resel.groupingspan.className='groupinglabel';resel.div.appendChild(resel.groupingspan);resel.progressouter.className='dndupload-progress-outer';resel.progress.className='dndupload-progress-inner';resel.progress.innerHTML='&nbsp;';resel.progressouter.appendChild(resel.progress);resel.div.appendChild(resel.progressouter);modsel.insertBefore(resel.li,modsel.get('children').pop());return resel},hide_preview_element:function(){this.Y.all('li.dndupload-preview').addClass('dndupload-hidden');this.Y.all('.dndupload-over').removeClass('dndupload-over')},show_preview_element:function(section,type){this.hide_preview_element();var preview=section.one('li.dndupload-preview').removeClass('dndupload-hidden');section.addClass('dndupload-over');var node=preview.one('span').getDOMNode();node.firstChild.nodeValue=type.addmessage},add_preview_element:function(section){var modsel=this.get_mods_element(section),preview={li:document.createElement('li'),div:document.createElement('div'),icon:document.createElement('img'),namespan:document.createElement('span')};preview.li.className='dndupload-preview dndupload-hidden';preview.div.className='mod-indent';preview.li.appendChild(preview.div);preview.icon.src=M.util.image_url('t/addfile');preview.icon.className='icon';preview.div.appendChild(preview.icon);preview.div.appendChild(document.createTextNode(' '));preview.namespan.className='instancename';preview.namespan.innerHTML=M.util.get_string('addfilehere','moodle');preview.div.appendChild(preview.namespan);modsel.appendChild(preview.li)},handle_file:function(file,section,sectionnumber){var handlers=new Array(),filehandlers=this.handlers.filehandlers,extension='',dotpos=file.name.lastIndexOf('.');if(dotpos!=-1)extension=file.name.substr(dotpos+1,file.name.length).toLowerCase();for(var i=0;i<filehandlers.length;i++)if(filehandlers[i].extension=='*'||filehandlers[i].extension==extension)handlers.push(filehandlers[i]);if(handlers.length==0)return;if(handlers.length==1){this.upload_file(file,section,sectionnumber,handlers[0].module);return};this.file_handler_dialog(handlers,extension,file,section,sectionnumber)},file_handler_dialog:function(handlers,extension,file,section,sectionnumber){if(this.uploaddialog){var details=new Object();details.isfile=true;details.handlers=handlers;details.extension=extension;details.file=file;details.section=section;details.sectionnumber=sectionnumber;this.uploadqueue.push(details);return};this.uploaddialog=true;var timestamp=new Date().getTime(),uploadid=Math.round(Math.random()*1e5)+'-'+timestamp,content='',sel;if(extension in this.lastselected){sel=this.lastselected[extension]}else sel=handlers[0].module;content+='<p>'+M.util.get_string('actionchoice','moodle',file.name)+'</p>';content+='<div id="dndupload_handlers'+uploadid+'">';for(var i=0;i<handlers.length;i++){var id='dndupload_handler'+uploadid+handlers[i].module,checked=(handlers[i].module==sel)?'checked="checked" ':'';content+='<input type="radio" name="handler" value="'+handlers[i].module+'" id="'+id+'" '+checked+'/>';content+=' <label for="'+id+'">';content+=handlers[i].message;content+='</label><br/>'};content+='</div>';var Y=this.Y,self=this,panel=new M.core.dialogue({bodyContent:content,width:'350px',modal:true,visible:true,render:true,align:{node:null,points:[Y.WidgetPositionAlign.CC,Y.WidgetPositionAlign.CC]}});panel.after("visibleChange",function(e){if(!panel.get('visible')){panel.destroy(true);self.check_upload_queue()}});panel.addButton({label:M.util.get_string('upload','moodle'),action:function(e){e.preventDefault();var module=false,div=Y.one('#dndupload_handlers'+uploadid);div.all('input').each(function(input){if(input.get('checked'))module=input.get('value')});if(!module)return;panel.hide();self.lastselected[extension]=module;self.upload_file(file,section,sectionnumber,module)},section:Y.WidgetStdMod.FOOTER});panel.addButton({label:M.util.get_string('cancel','moodle'),action:function(e){e.preventDefault();panel.hide()},section:Y.WidgetStdMod.FOOTER})},check_upload_queue:function(){this.uploaddialog=false;if(this.uploadqueue.length==0)return;var details=this.uploadqueue.shift();if(details.isfile){this.file_handler_dialog(details.handlers,details.extension,details.file,details.section,details.sectionnumber)}else this.handle_item(details.type,details.contents,details.section,details.sectionnumber)},upload_file:function(file,section,sectionnumber,module){var xhr=new XMLHttpRequest(),self=this;if(file.size>this.maxbytes){alert("'"+file.name+"' "+M.util.get_string('filetoolarge','moodle'));return};var resel=this.add_resource_element(file.name,section,module);xhr.upload.addEventListener('progress',function(e){if(e.lengthComputable){var percentage=Math.round((e.loaded*100)/e.total);resel.progress.style.width=percentage+'%'}},false);xhr.onreadystatechange=function(){if(xhr.readyState==4)if(xhr.status==200){var result=JSON.parse(xhr.responseText);if(result)if(result.error==0){if(result.content){resel.indentdiv.innerHTML='<div class="activityinstance" ></div>'+result.content+result.commands}else{resel.icon.src=result.icon;resel.a.href=result.link;resel.namespan.innerHTML=result.name;if(!parseInt(result.visible,10))resel.a.className='dimmed';if(result.groupingname){resel.groupingspan.innerHTML='('+result.groupingname+')'}else resel.div.removeChild(resel.groupingspan);resel.div.removeChild(resel.progressouter);resel.indentdiv.innerHTML+=result.commands;if(result.onclick)resel.a.onclick=result.onclick;if(self.Y.UA.gecko>0)resel.div.innerHTML=unescape(resel.div.innerHTML)};resel.li.id=result.elementid;self.add_editing(result.elementid)}else{resel.parent.removeChild(resel.li);alert(result.error)}}else alert(M.util.get_string('servererror','moodle'))};var formData=new FormData();formData.append('repo_upload_file',file);formData.append('sesskey',M.cfg.sesskey);formData.append('course',this.courseid);formData.append('section',sectionnumber);formData.append('module',module);formData.append('type','Files');xhr.open("POST",this.url,true);xhr.send(formData)},handle_item:function(type,contents,section,sectionnumber){if(type.handlers.length==0)return;if(type.handlers.length==1&&type.handlers[0].noname){this.upload_item('',type.type,contents,section,sectionnumber,type.handlers[0].module);this.check_upload_queue();return};if(this.uploaddialog){var details=new Object();details.isfile=false;details.type=type;details.contents=contents;details.section=section;details.setcionnumber=sectionnumber;this.uploadqueue.push(details);return};this.uploaddialog=true;var timestamp=new Date().getTime(),uploadid=Math.round(Math.random()*1e5)+'-'+timestamp,nameid='dndupload_handler_name'+uploadid,content='';if(type.handlers.length>1){content+='<p>'+type.handlermessage+'</p>';content+='<div id="dndupload_handlers'+uploadid+'">';var sel=type.handlers[0].module;for(var i=0;i<type.handlers.length;i++){var id='dndupload_handler'+uploadid+type.handlers[i].module,checked=(type.handlers[i].module==sel)?'checked="checked" ':'';content+='<input type="radio" name="handler" value="'+i+'" id="'+id+'" '+checked+'/>';content+=' <label for="'+id+'">';content+=type.handlers[i].message;content+='</label><br/>'};content+='</div>'};var disabled=(type.handlers[0].noname)?' disabled = "disabled" ':'';content+='<label for="'+nameid+'">'+type.namemessage+'</label>';content+=' <input type="text" id="'+nameid+'" value="" '+disabled+' />';var Y=this.Y,self=this,panel=new M.core.dialogue({bodyContent:content,width:'350px',modal:true,visible:true,render:true,align:{node:null,points:[Y.WidgetPositionAlign.CC,Y.WidgetPositionAlign.CC]}});panel.after("visibleChange",function(e){if(!panel.get('visible')){panel.destroy(true);self.check_upload_queue()}});var namefield=Y.one('#'+nameid),submit=function(e){e.preventDefault();var name=Y.Lang.trim(namefield.get('value')),module=false,noname=false;if(type.handlers.length>1){var div=Y.one('#dndupload_handlers'+uploadid);div.all('input').each(function(input){if(input.get('checked')){var idx=input.get('value');module=type.handlers[idx].module;noname=type.handlers[idx].noname}});if(!module)return}else{module=type.handlers[0].module;noname=type.handlers[0].noname};if(name==''&&!noname)return;if(noname)name='';panel.hide();self.upload_item(name,type.type,contents,section,sectionnumber,module)};panel.addButton({label:M.util.get_string('upload','moodle'),action:submit,section:Y.WidgetStdMod.FOOTER,name:'submit'});panel.addButton({label:M.util.get_string('cancel','moodle'),action:function(e){e.preventDefault();panel.hide()},section:Y.WidgetStdMod.FOOTER});var submitbutton=panel.getButton('submit').button;namefield.on('key',submit,'enter');namefield.after('keyup',function(){if(Y.Lang.trim(namefield.get('value'))==''){submitbutton.disable()}else submitbutton.enable()});for(i=0;i<type.handlers.length;i++)if(type.handlers[i].noname){Y.one('#dndupload_handler'+uploadid+type.handlers[i].module).on('click',function(e){namefield.set('disabled','disabled');submitbutton.enable()})}else Y.one('#dndupload_handler'+uploadid+type.handlers[i].module).on('click',function(e){namefield.removeAttribute('disabled');namefield.focus();if(Y.Lang.trim(namefield.get('value'))=='')submitbutton.disable()});Y.one('#'+nameid).focus()},upload_item:function(name,type,contents,section,sectionnumber,module){var xhr=new XMLHttpRequest(),self=this,resel=this.add_resource_element(name,section,module);xhr.onreadystatechange=function(){if(xhr.readyState==4)if(xhr.status==200){var result=JSON.parse(xhr.responseText);if(result)if(result.error==0){if(result.content){resel.indentdiv.innerHTML='<div class="activityinstance" ></div>'+result.content+result.commands}else{resel.icon.src=result.icon;resel.a.href=result.link;resel.namespan.innerHTML=result.name;if(!parseInt(result.visible,10))resel.a.className='dimmed';if(result.groupingname){resel.groupingspan.innerHTML='('+result.groupingname+')'}else resel.div.removeChild(resel.groupingspan);resel.div.removeChild(resel.progressouter);resel.div.innerHTML+=result.commands;if(result.onclick)resel.a.onclick=result.onclick;if(self.Y.UA.gecko>0)resel.div.innerHTML=unescape(resel.div.innerHTML)};resel.li.id=result.elementid;self.add_editing(result.elementid,sectionnumber)}else{resel.parent.removeChild(resel.li);alert(result.error)}}else alert(M.util.get_string('servererror','moodle'))};var formData=new FormData();formData.append('contents',contents);formData.append('displayname',name);formData.append('sesskey',M.cfg.sesskey);formData.append('course',this.courseid);formData.append('section',sectionnumber);formData.append('type',type);formData.append('module',module);xhr.open("POST",this.url,true);xhr.send(formData)},add_editing:function(elementid){YUI().use('moodle-course-coursebase',function(Y){M.course.coursebase.invoke_function('setup_for_resource','#'+elementid)})}}