function addtobackpack(event,args){var badgetable=Y.one('#issued-badge-table'),errordiv=Y.one('#addtobackpack-error'),errortext=M.util.get_string('error:backpackproblem','badges'),errorhtml='<div id="addtobackpack-error" class="box boxaligncenter notifyproblem">'+errortext+'</div>';if(typeof OpenBadges!=='undefined'){OpenBadges.issue([args.assertion],function(errors,successes){})}else if(!errordiv){var badgerror=Y.Node.create(errorhtml);badgetable.insert(badgerror,'before')}}
function check_site_access(){var add=Y.one('#check_connection'),callback={method:"GET",on:{success:function(id,o,args){var data=Y.JSON.parse(o.responseText);if(data.code=='http-unreachable'){add.setHTML(data.response);add.removeClass('hide')}},failure:function(o){}}};Y.use('io-base',function(Y){Y.io('ajax.php',callback)});return false}
function badges_set_connection_progress(status){switch(status){case'connecting':var connecting=M.util.get_string('connecting','badges'),imageurl=M.util.image_url('i/loading_small','moodle'),loading=Y.Node.create(connecting+'&nbsp;<img src="'+imageurl+'" width="16" height="16" alt="'+connecting+'"/>');Y.one('#connection-status').removeClass('notconnected').addClass('connecting').setHTML(loading);break;case'notconnected':var notconnected=M.util.get_string('notconnected','badges');Y.one('#connection-status').removeClass('connecting').addClass('notconnected').setHTML(notconnected);break;default:}}
function badges_set_error_message(messagekey,param){var errortext=M.util.get_string(messagekey,'badges',param);Y.one('#connection-error').setHTML(errortext)}
function badges_handle_assertion(assertion){if(!assertion){var noassertionstr=M.util.get_string('error:noassertion','badges');badges_set_error_message('error:backpackloginfailed',noassertionstr);return};badges_set_connection_progress('connecting');Y.io("backpackconnect.php",{method:"POST",data:"assertion="+assertion+"&sesskey="+M.cfg.sesskey,on:{success:function(id,result){window.location.href="mybackpack.php"},failure:function(id,result){try{var parsedResponse=Y.JSON.parse(result.response)}catch(e){badges_set_connection_progress('notconnected');var badjsonstr=M.util.get_string('error:badjson','badges');badges_set_error_message('error:backpackloginfailed',badjsonstr);return};badges_set_connection_progress('notconnected');badges_set_error_message('error:backpackloginfailed',parsedResponse.reason);return}}})}
function badges_init_persona_login_button(){var imageurl=M.util.image_url('i/persona_sign_in_black','moodle'),imagealt=M.util.get_string('signinwithyouremail','badges'),button=Y.Node.create('<img id="persona_signin" src="'+imageurl+'" width="202" height="25" alt="'+imagealt+'"/>');Y.one('#persona-container').append(button);button.on('click',function(){Y.one('#connection-error').empty();navigator.id.get(badges_handle_assertion)})}